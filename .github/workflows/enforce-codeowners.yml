name: Enforce CODEOWNERS per branch

on:
  push:
    branches:
      - main
      - develop
      - "task/**"
      - "tag/**"

permissions:
  contents: write

jobs:
  enforce:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main for trusted config
        run: git fetch origin main --depth=1

      - name: Enforce CODEOWNERS content (trusted config)
        shell: bash
        env:
          BRANCH: ${{ github.ref_name }}
          BEFORE: ${{ github.event.before }}
        run: |
          set -e

          if [ "$BRANCH" = "main" ]; then
            REF="$BEFORE"
          else
            REF="origin/main"
          fi

          git show "${REF}:.github/psylens-access.json" > /tmp/psylens-access.json 2>/dev/null || true

          python3 - <<'PY'
          import json, os, re, sys

          path = "/tmp/psylens-access.json"
          if not os.path.exists(path) or os.path.getsize(path) == 0:
            sys.exit(1)

          cfg = json.load(open(path, "r", encoding="utf-8"))
          director = cfg["director"]
          coords = cfg.get("coordinators", [])
          tag_map = cfg.get("tag_map", {})

          branch = os.environ["GITHUB_REF_NAME"]

          def at(u): return "@"+u
          director_at = at(director)
          coords_at = " ".join(at(u) for u in coords)

          expected = None

          if branch == "main":
            expected = f"* {director_at}"
          elif (branch == "develop") or branch.startswith("task/"):
            expected = f"* {director_at} {coords_at}".strip()
          else:
            m = re.match(r"^tag\/\d{3}-[a-z0-9]+(?:-[a-z0-9]+)*\/([a-z0-9]+)$", branch)
            if m:
              tag = m.group(1)
              owner = tag_map.get(tag)
              if not owner:
                sys.exit(1)
              expected = f"* {director_at} {coords_at} {at(owner)}".strip()

          if expected is None:
            sys.exit(0)

          os.makedirs(".github", exist_ok=True)
          open(".github/CODEOWNERS", "w", encoding="utf-8").write(expected + "\n")
          PY

          if git diff --quiet; then
            exit 0
          fi

          git config user.name "psylens-bot"
          git config user.email "psylens-bot@users.noreply.github.com"
          git add .github/CODEOWNERS
          git commit -m "Enforce CODEOWNERS for $GITHUB_REF_NAME"
          git push
