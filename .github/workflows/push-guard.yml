name: Push Guard (branch policy)

on:
  push:
    branches:
      - main
      - develop
      - "task/**"
      - "tag/**"

permissions:
  contents: write
  issues: write

jobs:
  guard:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide if push is authorized
        id: auth
        shell: bash
        run: |
          set -e
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os, re

          cfg = json.load(open(".github/psylens-access.json"))
          director = cfg["director"]
          coords = cfg.get("coordinators", [])
          tag_map = cfg.get("tag_map", {})

          branch = os.environ["GITHUB_REF_NAME"]
          actor  = os.environ["GITHUB_ACTOR"]

          def eq(a,b): return str(a).lower() == str(b).lower()

          allowed = []

          if branch == "main":
            allowed = [director]

          elif branch == "develop" or branch.startswith("task/"):
            allowed = [director] + coords

          else:
            m = re.match(r"^tag\/\d{3}-[a-z0-9]+(?:-[a-z0-9]+)*\/([a-z0-9]+)$", branch)
            if m:
              tag = m.group(1)
              owner = tag_map.get(tag)
              if owner:
                allowed = [director] + coords + [owner]

          authorized = any(eq(actor, u) for u in allowed)
          print("authorized=" + ("yes" if authorized else "no"))
          PY

      - name: Revert unauthorized pushes
        if: steps.auth.outputs.authorized != 'yes'
        shell: bash
        env:
          BRANCH: ${{ github.ref_name }}
          BEFORE: ${{ github.event.before }}
          AFTER: ${{ github.sha }}
        run: |
          set -e

          echo "Unauthorized push by $GITHUB_ACTOR to $BRANCH. Reverting $BEFORE..$AFTER"

          git config user.name "psylens-guard"
          git config user.email "psylens-guard@users.noreply.github.com"

          commits="$(git rev-list --reverse "$BEFORE..$AFTER" || true)"
          if [ -z "$commits" ]; then
            exit 1
          fi

          for c in $commits; do
            git revert --no-edit "$c" || { git revert --abort; exit 1; }
          done

          git push origin "HEAD:$BRANCH"
          exit 1

      - name: Open issue if revert failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Push Guard failed on ${context.ref.replace('refs/heads/','')}`,
              body: `Actor: @${context.actor}\nBranch: \`${context.ref.replace('refs/heads/','')}\`\nCommit: \`${context.sha}\`\n\nRevert failed (likely conflict). Manual intervention needed.`
            });
