name: Push Guard (branch policy)

on:
  push:
    branches:
      - main
      - develop
      - "task/**"
      - "tag/**"

permissions:
  contents: write
  issues: write

jobs:
  guard:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main for trusted config
        run: git fetch origin main --depth=1

      - name: Decide if push is authorized (trusted config)
        id: auth
        shell: bash
        env:
          BRANCH: ${{ github.ref_name }}
          BEFORE: ${{ github.event.before }}
        run: |
          set -e

          if [ "$BRANCH" = "main" ]; then
            REF="$BEFORE"
          else
            REF="origin/main"
          fi

          git show "${REF}:.github/psylens-access.json" > /tmp/psylens-access.json 2>/dev/null || true

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os, re, sys

          path = "/tmp/psylens-access.json"
          if not os.path.exists(path) or os.path.getsize(path) == 0:
            print("authorized=no"); sys.exit(0)

          cfg = json.load(open(path, "r", encoding="utf-8"))
          director = cfg["director"]
          coords = cfg.get("coordinators", [])
          tag_map = cfg.get("tag_map", {})

          branch = os.environ["GITHUB_REF_NAME"]
          actor  = os.environ["GITHUB_ACTOR"]

          def eq(a,b): return str(a).lower() == str(b).lower()

          allowed = []
          if branch == "main":
            allowed = [director]
          elif branch == "develop" or branch.startswith("task/"):
            allowed = [director] + coords
          else:
            m = re.match(r"^tag\/\d{3}-[a-z0-9]+(?:-[a-z0-9]+)*\/([a-z0-9]+)$", branch)
            if m:
              tag = m.group(1)
              owner = tag_map.get(tag)
              if owner:
                allowed = [director] + coords + [owner]

          print("authorized=" + ("yes" if any(eq(actor,u) for u in allowed) else "no"))
          PY

      - name: Revert unauthorized pushes
        if: steps.auth.outputs.authorized != 'yes'
        shell: bash
        env:
          BRANCH: ${{ github.ref_name }}
          BEFORE: ${{ github.event.before }}
          AFTER: ${{ github.sha }}
        run: |
          set -e

          git config user.name "psylens-guard"
          git config user.email "psylens-guard@users.noreply.github.com"

          commits="$(git rev-list --reverse "$BEFORE..$AFTER" || true)"
          [ -n "$commits" ] || exit 1

          for c in $commits; do
            git revert --no-edit "$c" || { git revert --abort; exit 1; }
          done

          git push origin "HEAD:$BRANCH"
          exit 1

      - name: Open issue if revert failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Push Guard failed on ${context.ref.replace('refs/heads/','')}`,
              body: `Actor: @${context.actor}\nBranch: \`${context.ref.replace('refs/heads/','')}\`\nCommit: \`${context.sha}\`\n\nRevert failed (likely conflict). Manual intervention needed.`
            });
