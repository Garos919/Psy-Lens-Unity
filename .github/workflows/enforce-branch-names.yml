name: Enforce branch naming

on:
  create:

permissions:
  contents: write

jobs:
  enforce:
    runs-on: ubuntu-latest
    if: ${{ github.event.ref_type == 'branch' && github.actor != 'github-actions[bot]' }}
    steps:
      - name: Delete invalid / unauthorized branches
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.ref;
            const actor  = context.actor;

            // Load config from main
            const cfgRes = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: ".github/psylens-access.json",
              ref: "main",
            });

            const cfg = JSON.parse(Buffer.from(cfgRes.data.content, "base64").toString("utf8"));
            const director = cfg.director;
            const coordinators = cfg.coordinators || [];
            const tagMap = cfg.tag_map || {};

            const eq = (a,b) => String(a).toLowerCase() === String(b).toLowerCase();
            const isDirectorOrCoord =
              eq(actor, director) || coordinators.some(u => eq(u, actor));

            const isMain = branch === "main";
            const isDevelop = branch === "develop";

            // task/123-task-title (3 digits)
            const taskRe = /^task\/\d{3}-[a-z0-9]+(?:-[a-z0-9]+)*$/;

            // tag/123-task-title/ngar (3 digits, tag is lowercase alnum only)
            const tagRe  = /^tag\/\d{3}-[a-z0-9]+(?:-[a-z0-9]+)*\/[a-z0-9]+$/;

            const isTask = taskRe.test(branch);
            const isTag  = tagRe.test(branch);

            // Name allowed?
            const nameAllowed = isMain || isDevelop || isTask || isTag;
            if (!nameAllowed) {
              await github.rest.git.deleteRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `heads/${branch}` });
              return;
            }

            // Creator allowed?
            let creatorAllowed = false;

            if (isMain || isDevelop || isTask) {
              creatorAllowed = isDirectorOrCoord;
            } else if (isTag) {
              const tag = branch.split("/")[2];           // last segment is tag
              const mappedUser = tagMap[tag];             // tag -> GitHub username
              if (!mappedUser) {
                await github.rest.git.deleteRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `heads/${branch}` });
                return;
              }
              creatorAllowed = isDirectorOrCoord || eq(actor, mappedUser);
            }

            if (!creatorAllowed) {
              await github.rest.git.deleteRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `heads/${branch}` });
              return;
            }
